# sfnt.ts å…³é”®é—®é¢˜ä¿®å¤

## ğŸ› å‘ç°çš„é—®é¢˜

ç”¨æˆ·æŠ¥å‘Šï¼š
- parseç”Ÿæˆçš„å¯å˜å­—ä½“æ—¶ï¼Œnameè¡¨çš„offsetæœ‰é—®é¢˜
- checksumå€¼è¿‡å¤§ï¼š`13305381898` > 2Â³Â² (æº¢å‡º)
- name record dataæœ¬èº«æ˜¯æ­£ç¡®çš„ï¼š`[110, 97, 109, 101, 166, 46, 44, 9, 0, 0, 1, 132, 0, 0, 1, 68]`

## ğŸ” æ ¹æœ¬åŸå› 

### é—®é¢˜1ï¼šCheckSumæº¢å‡º
```typescript
// âŒ åŸä»£ç ï¼ˆç¬¬238-239è¡Œï¼‰
checksum += computeCheckSum(recordData)
checksum += computeCheckSum(tableData)
// ... æ²¡æœ‰åšæ¨¡è¿ç®—

// ç¬¬265è¡Œçš„æ¨¡è¿ç®—è¢«æ³¨é‡Šæ‰äº†
//checksum %= 0x100000000
```

**åæœ**ï¼šchecksumç´¯åŠ åè¶…å‡º32ä½æ— ç¬¦å·æ•´æ•°èŒƒå›´ï¼ˆ4,294,967,295ï¼‰ï¼Œå¯¼è‡´åç»­è®¡ç®—é”™è¯¯ã€‚

### é—®é¢˜2ï¼šOffsetä¸æ•°æ®é¡ºåºä¸åŒ¹é…ï¼ˆæ›´ä¸¥é‡ï¼ï¼‰

**åŸä»£ç æµç¨‹**ï¼š
1. ç¬¬182-246è¡Œï¼šæŒ‰**åŸå§‹keysé¡ºåº**è®¡ç®—offsetå¹¶ç”ŸæˆtablesData
2. ç¬¬250-261è¡Œï¼škeys**æ’åºå**ç”ŸæˆrecordsData

**åæœ**ï¼š
- è¡¨ç›®å½•ä¸­çš„offsetæ˜¯æŒ‰åŸå§‹é¡ºåºè®¡ç®—çš„
- ä½†è¡¨ç›®å½•æœ¬èº«æ˜¯æŒ‰æ’åºåé¡ºåºçš„
- tablesDataä¹Ÿæ˜¯æŒ‰åŸå§‹é¡ºåºæ‹¼æ¥çš„
- ç»“æœï¼šè¡¨ç›®å½•è¯´"nameåœ¨offset X"ï¼Œä½†å®é™…nameæ•°æ®åœ¨offset Yï¼

**ä¸¾ä¾‹**ï¼š
```
åŸå§‹keys: ['head', 'name', 'CFF ', 'OS/2', ...]
æ’åºåkeys: ['CFF ', 'OS/2', 'head', 'name', ...]

åŸä»£ç ï¼š
- offsetæŒ‰åŸå§‹é¡ºåºè®¡ç®—: head=188, name=242, CFF=566, OS/2=...
- è¡¨ç›®å½•æŒ‰æ’åºåå†™å…¥: CFF(offset=188?), OS/2(...), head(...), name(offset=242?)
- ä½†tablesDataè¿˜æ˜¯: [headæ•°æ®, nameæ•°æ®, CFFæ•°æ®, OS/2æ•°æ®, ...]

ç»“æœï¼šoffsetå®Œå…¨é”™ä¹±ï¼
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒåŸåˆ™ï¼šå…ˆæ’åºï¼Œå†æŒ‰æ’åºåçš„é¡ºåºåšä¸€åˆ‡

```typescript
// 1. å…ˆæ’åºkeys
keys.sort((key1, key2) => {
    if (key1 > key2) return 1
    else return -1
})

// 2. æŒ‰æ’åºåçš„é¡ºåºè®¡ç®—offsetå¹¶ç”Ÿæˆæ‰€æœ‰æ•°æ®
for (let i = 0; i < keys.length; i++) {
    const key = keys[i]
    
    // ç”ŸæˆtableData
    let tableData = ...
    
    // è®¡ç®—offsetï¼ˆåŸºäºæ’åºåçš„é¡ºåºï¼‰
    const recordData = createRecord({
        tag: key,
        checkSum,
        offset,  // â† æ­£ç¡®çš„offset
        length: tableLength,
    })
    
    // ç«‹å³æ‹¼æ¥recordDataï¼ˆæŒ‰æ’åºåçš„é¡ºåºï¼‰
    recordsData = recordsData.concat(recordData)
    
    // ç«‹å³æ‹¼æ¥tableDataï¼ˆæŒ‰æ’åºåçš„é¡ºåºï¼‰
    tablesData = tablesData.concat(tableData)
    
    // ç´¯åŠ checksumå¹¶ç«‹å³åšæ¨¡è¿ç®—
    checksum += computeCheckSum(recordData)
    checksum %= 0x100000000  // â† é˜²æ­¢æº¢å‡º
    checksum += computeCheckSum(tableData)
    checksum %= 0x100000000  // â† é˜²æ­¢æº¢å‡º
    
    offset += tableLength
    // 4å­—èŠ‚å¯¹é½...
}
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

ä¿®å¤åï¼Œæ’åºåçš„keysé¡ºåºä¸ºï¼š
```
['CFF ', 'OS/2', 'cmap', 'fvar', 'gvar', 'head', 'hhea', 'hmtx', 'maxp', 'name', 'post']
```

- è¡¨ç›®å½•æŒ‰æ­¤é¡ºåºå†™å…¥ âœ…
- offsetæŒ‰æ­¤é¡ºåºè®¡ç®— âœ…
- tablesDataæŒ‰æ­¤é¡ºåºæ‹¼æ¥ âœ…
- checksumä¸ä¼šæº¢å‡º âœ…

ç°åœ¨ï¼š
- è¡¨ç›®å½•è¯´"nameåœ¨offset 15008" â†’ å®é™…nameæ•°æ®å°±åœ¨offset 15008 âœ…
- æ‰€æœ‰è¡¨çš„offsetéƒ½æ­£ç¡® âœ…
- parseèƒ½æ­£ç¡®è¯»å– âœ…

## ğŸ§ª æµ‹è¯•

é‡æ–°ç”Ÿæˆå¯å˜å­—ä½“åï¼š
1. æŸ¥çœ‹è°ƒè¯•è¾“å‡ºä¸­çš„name tableä¿¡æ¯
2. ç”¨é¡¹ç›®è‡ªå¸¦çš„parseåŠŸèƒ½å¯¼å…¥ç”Ÿæˆçš„å­—ä½“
3. æ£€æŸ¥æ‰€æœ‰è¡¨çš„offsetæ˜¯å¦æ­£ç¡®
4. ç”¨ttxéªŒè¯ï¼š`ttx -l yourfont.otf`
5. ç”¨Font ValidatoréªŒè¯

## ğŸ’¡ å…³é”®ç»éªŒ

1. **OpenTypeè§„èŒƒ**ï¼šè¡¨ç›®å½•**å¿…é¡»**æŒ‰å­—æ¯é¡ºåºæ’åˆ—
2. **offsetè®¡ç®—**ï¼šå¿…é¡»åŸºäº**å®é™…æ•°æ®å¸ƒå±€é¡ºåº**
3. **32ä½æ•´æ•°**ï¼šåœ¨JavaScriptä¸­ç´¯åŠ checksumæ—¶ï¼Œå¿…é¡»å®šæœŸåšæ¨¡è¿ç®—
4. **ä¸€è‡´æ€§**ï¼šè¡¨ç›®å½•é¡ºåº = offsetè®¡ç®—é¡ºåº = æ•°æ®æ‹¼æ¥é¡ºåº

## ğŸ“ å…¶ä»–ä¿®æ”¹

- ç§»é™¤äº†é‡å¤çš„æ’åºå¾ªç¯
- ç®€åŒ–äº†headè¡¨çš„checksumè®¡ç®—é€»è¾‘
- æ·»åŠ äº†è¯¦ç»†çš„è°ƒè¯•è¾“å‡º
- æ¯æ¬¡checksumç´¯åŠ åéƒ½åšæ¨¡è¿ç®—ï¼Œç¡®ä¿ä¸æº¢å‡º

