# 📐 轮廓相交问题说明

## 🎯 你的问题

> "存在intersect contour是否是因为我没有去除重叠？可是去除重叠之后，就不能保证delta计算时点一一对应了……怎么办呢"

**回答：你的理解完全正确！** 👍

## 🔍 问题分析

### 矛盾：去除重叠 vs 点对应

这是可变字体的核心矛盾：

```
┌─────────────────────────────────────────┐
│ 去除重叠（Remove Overlap）               │
├─────────────────────────────────────────┤
│ ✅ 轮廓不相交                            │
│ ✅ 符合字体质量标准                       │
│ ✅ 没有Font Validator警告                │
│                                         │
│ ❌ 改变点的数量                          │
│ ❌ 改变点的顺序                          │
│ ❌ 不同变体的结果不一致                   │
│ → 无法用于可变字体！                      │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 保持重叠（Keep Overlap）                 │
├─────────────────────────────────────────┤
│ ✅ 点数量一致                            │
│ ✅ 点顺序一致                            │
│ ✅ 可以计算delta                         │
│ ✅ 可变字体正常工作                       │
│                                         │
│ ❌ 轮廓可能相交                          │
│ ❌ Font Validator警告                   │
│ → 但可以正常使用！                        │
└─────────────────────────────────────────┘
```

## ✅ 解决方案

### 对于可变字体：**必须保持重叠**

**原因**：
1. gvar表要求所有变体的点数量和顺序完全一致
2. 去除重叠会破坏这个一致性
3. 无法保证不同weight下的"去除重叠"产生相同数量的点

### 行业实践

**很多专业可变字体都有轮廓相交**：

例子：
- Google Fonts的Noto Sans CJK Variable
- Adobe的Source Han Sans Variable
- 各种可变中文字体

**它们的做法**：
- ✅ 保持轮廓相交（笔画组装）
- ✅ 使用non-zero winding rule正确填充
- ✅ Font Book正常显示
- ✅ Photoshop正常使用
- ⚠️ Font Validator有警告（但忽略）

## 📊 Font Validator错误解读

### E1111: Intersecting contours

**含义**：轮廓之间有相交

**影响**：
- ✅ 不影响字体安装
- ✅ 不影响Font Book显示
- ✅ 不影响Photoshop使用
- ✅ 不影响可变字体功能
- ⚠️ 可能在某些严格的环境中有警告

**是否需要修复**：
- 普通字体：建议修复（去除重叠）
- 可变字体：**不能修复**（必须保持重叠）

### W1112: Not all extremes are marked

**含义**：曲线的极值点（最高点、最低点等）应该是on-curve点

**影响**：
- ⚠️ 提示/警告级别
- ✅ 不影响字体使用
- ✅ 只是优化建议

**是否需要修复**：
- 可选，优化项
- 对可变字体功能没有影响

### E1403/E1410: hhea度量值误差

**含义**：计算值与实际值差1

**影响**：
- ⚠️ 非常小的误差
- ✅ 不影响显示
- ✅ 只是舍入问题

**是否需要修复**：
- 已修复（添加Math.round）

## 🎯 关键测试

**忽略Font Validator的警告，重点测试Font Book！**

### Font Book测试（最重要！）

```bash
open -a "Font Book" yourfont.otf
```

**成功标志**：
1. ✅ 字体安装成功
2. ✅ 双击打开预览窗口
3. ✅ **顶部有滑块！** 🎊
4. ✅ 拖动滑块，字形平滑变化
5. ✅ 没有崩溃或显示错误

**如果以上都OK，那就成功了！** 🎉

### Photoshop测试

1. 安装字体
2. 重启Photoshop
3. 创建文本图层
4. 选择字体，输入文字
5. 查看可变字体控件

**如果Photoshop也正常，那就完美了！** ✨

### 实际渲染测试

在macOS预览（Preview）、Safari、Chrome等应用中测试：
- 字形显示是否正确
- 笔画是否完整
- 有没有"镂空"问题

## 💡 关于"Intersecting contours"

### 为什么会有？

你使用**笔画组装方式**生成字形：
```
横 + 竖 + 撇 + 捺 = 字
```

笔画之间自然会有重叠/相交。

### 为什么不能去除重叠？

```
Weight=100（细）:
  横：10个点
  竖：8个点
  去除重叠后：可能变成15个点（合并后）

Weight=900（粗）:
  横：12个点
  竖：10个点
  去除重叠后：可能变成18个点（合并后）

结果：15 ≠ 18 → 点数量不一致 ❌
```

### 解决方案

**接受轮廓相交**：

1. **使用non-zero winding rule** - 你已经在用了
2. **确保轮廓方向正确** - 外轮廓顺时针，内轮廓逆时针
3. **测试实际显示效果**

**如果显示正常，Font Validator的警告可以忽略！**

## 🧪 立即测试

### 步骤1：Font Book测试

```bash
open -a "Font Book" yourfont.otf
```

**关键问题**：
- [ ] 有滑块吗？
- [ ] 能拖动吗？
- [ ] 字形变化正常吗？

### 步骤2：查看字形

在Font Book预览中：
- [ ] 字形显示完整吗？
- [ ] 有没有"镂空"或缺失？
- [ ] 笔画重叠部分正常吗？

### 步骤3：测试变化

拖动滑块：
- [ ] 从细到粗平滑过渡？
- [ ] 没有突然跳跃或变形？
- [ ] 所有笔画都正常变化？

## 📊 如果测试通过

**恭喜！你成功了！** 🎉

Font Validator的警告可以忽略：
- E1111 (Intersecting contours) - 可变字体的正常现象
- W1112 (Extremes not marked) - 优化建议，不影响功能
- E1403/E1410 (hhea误差) - 已修复，差1像素可忽略

**你已经实现了完整的可变字体功能！**

## 📊 如果Font Book没有滑块

那我们需要检查：
1. fvar表是否正确生成
2. gvar表是否正确生成
3. 控制台日志

请提供：
```bash
ttx -t fvar yourfont.otf
```

## 🎯 总结

### 你的担心

> "去除重叠会破坏点对应"

**完全正确！** 这就是为什么可变字体必须保持重叠。

### 解决方案

**接受轮廓相交**，这是可变字体的标准做法。

### 关键指标

不是Font Validator，而是：
- ✅ **Font Book有滑块**
- ✅ **字形显示正常**
- ✅ **变化平滑**

---

**现在最重要的是：请测试Font Book，告诉我有没有滑块！** 🎯

如果有滑块且工作正常，那就**完全成功了**，Font Validator的警告可以完全忽略！🎊

